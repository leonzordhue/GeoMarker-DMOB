<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoMarker - DMOB</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>GeoMarker - DMOB</h1>
            <p class="description">Sistema de marca√ß√£o geogr√°fica para obras de arte especiais e infraestrutura rodovi√°ria</p>
        </header>
        
        <div class="app-content">
            <div class="map-section">
                <div class="map-container">
                    <div id="map"></div>
                    <div class="location-search">
                        <input type="text" id="search-location" placeholder="Digite o nome do munic√≠pio...">
                    </div>
                    <div class="map-controls">
                        <button id="zoom-in" title="Zoom In">+</button>
                        <button id="zoom-out" title="Zoom Out">-</button>
                        <button id="locate-me" title="Minha Localiza√ß√£o" class="gps">üìç</button>
                    </div>
                    <div class="marker-info" id="marker-info">
                        <strong id="info-name"></strong>
                        <div id="info-coords"></div>
                        <div id="info-desc"></div>
                    </div>
                    <div class="gps-status" id="gps-status" style="display: none;">
                        GPS: <span id="gps-accuracy">--</span>m de precis√£o
                    </div>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="tab-buttons">
                    <div class="tab-button active" data-tab="controls">Controles</div>
                    <div class="tab-button" data-tab="points">Pontos (<span id="points-count">0</span>)</div>
                </div>
                
                <div id="controls-tab" class="tab-content active">
                    <div class="municipio-selector">
                        <label for="municipio-select">Munic√≠pio do Amazonas:</label>
                        <select id="municipio-select"></select>
                    </div>
                    
                    <div class="manual-coords">
                        <label>Coordenadas Manuais:</label>
                        <div class="coord-inputs">
                            <input type="text" id="manual-lat" placeholder="Latitude (ex: -3.1190)">
                            <input type="text" id="manual-lng" placeholder="Longitude (ex: -60.0217)">
                        </div>
                        <button id="go-to-coords" class="secondary">üåç Ir para Coordenadas</button>
                    </div>

                    <!-- Se√ß√£o da C√¢mera (Mobile) -->
                    <div class="camera-section" id="camera-section" style="display: none;">
                        <div class="section-title">üì∏ C√¢mera Mobile</div>
                        
                        <div class="camera-controls">
                            <button id="start-camera" class="gps">üì∑ Abrir C√¢mera</button>
                            <button id="take-photo" class="secondary" style="display: none;">üéØ Tirar Foto com Coordenadas</button>
                            <button id="close-camera" class="secondary" style="display: none;">‚ùå Fechar</button>
                        </div>
                        
                        <div class="camera-preview" id="camera-preview" style="display: none;">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                            <div class="coords-overlay" id="coords-overlay">
                                <span id="live-coords">--,--</span>
                            </div>
                        </div>
                        
                        <div class="photo-result" id="photo-result" style="display: none;">
                            <img id="photo-preview" src="" alt="Preview da foto">
                            <div class="photo-actions">
                                <button id="use-photo" class="gps">‚úÖ Usar Esta Foto</button>
                                <button id="retake-photo" class="secondary">üîÑ Tirar Outra</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-title">Registro de Pontos</div>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="point-name">Identifica√ß√£o:</label>
                            <input type="text" id="point-name" placeholder="Nome do ponto">
                        </div>
                        
                        <div class="control-group">
                            <label for="point-category">Categoria:</label>
                            <select id="point-category">
                                <option value="ponte-oae">Ponte - OAE</option>
                                <option value="bueiro-oae">Bueiro - OAE</option>
                                <option value="galeria-oae">Galeria - OAE</option>
                                <option value="viario-urbano">Vi√°rio - Urbano</option>
                                <option value="jazida">Jazida</option>
                                <option value="ramal">Ramal</option>
                                <option value="rodovia">Rodovia</option>
                                <option value="patologias-pista">Patologias na Pista</option>
                                <option value="viaduto-oae">Viaduto - OAE</option>
                            </select>
                        </div>
                        
                        <div class="control-group full-width">
                            <label for="point-desc">Descri√ß√£o/Observa√ß√µes:</label>
                            <textarea id="point-desc" rows="2" placeholder="Descri√ß√£o detalhada e observa√ß√µes"></textarea>
                        </div>
                        
                        <div class="control-group full-width">
                            <label>Coordenadas Atuais:</label>
                            <input type="text" id="current-coords" readonly placeholder="Latitude, Longitude">
                        </div>
                    </div>
                    
                    <div class="buttons">
                        <button id="add-point">üìç Registrar Ponto</button>
                        <button id="add-gps-point" class="gps">üéØ Registrar com GPS</button>
                        <button id="center-map" class="secondary">üó∫Ô∏è Centralizar</button>
                        <button id="clear-points">üóëÔ∏è Limpar</button>
                        <button id="export-kml">üì§ Exportar KML</button>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item"><div class="stat-value" id="total-points">0</div><div class="stat-label">Total</div></div>
                        <div class="stat-item"><div class="stat-value" id="categories-count">0</div><div class="stat-label">Categorias</div></div>
                    </div>
                </div>
                
                <div id="points-tab" class="tab-content">
                    <div class="points-list" id="points-container"></div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>Como usar:</h3>
            <ol>
                <li>Use coordenadas manuais ou clique no mapa para definir localiza√ß√£o</li>
                <li>Ative o GPS para registro em tempo real</li>
                <li>Preencha identifica√ß√£o, categoria e descri√ß√£o</li>
                <li>Registre pontos manualmente ou com GPS ativo</li>
                <li>Acompanhe todos os pontos na aba "Pontos"</li>
                <li>Exporte os pontos em formato KML quando necess√°rio</li>
            </ol>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const elements = {
                map: document.getElementById('map'),
                pointName: document.getElementById('point-name'),
                pointDesc: document.getElementById('point-desc'),
                pointCategory: document.getElementById('point-category'),
                currentCoords: document.getElementById('current-coords'),
                addPoint: document.getElementById('add-point'),
                addGpsPoint: document.getElementById('add-gps-point'),
                clearPoints: document.getElementById('clear-points'),
                exportKml: document.getElementById('export-kml'),
                centerMap: document.getElementById('center-map'),
                pointsContainer: document.getElementById('points-container'),
                pointsCount: document.getElementById('points-count'),
                searchLocation: document.getElementById('search-location'),
                markerInfo: document.getElementById('marker-info'),
                infoName: document.getElementById('info-name'),
                infoCoords: document.getElementById('info-coords'),
                infoDesc: document.getElementById('info-desc'),
                totalPoints: document.getElementById('total-points'),
                categoriesCount: document.getElementById('categories-count'),
                municipioSelect: document.getElementById('municipio-select'),
                zoomIn: document.getElementById('zoom-in'),
                zoomOut: document.getElementById('zoom-out'),
                locateMe: document.getElementById('locate-me'),
                gpsStatus: document.getElementById('gps-status'),
                gpsAccuracy: document.getElementById('gps-accuracy'),
                manualLat: document.getElementById('manual-lat'),
                manualLng: document.getElementById('manual-lng'),
                goToCoords: document.getElementById('go-to-coords'),
                tabButtons: document.querySelectorAll('.tab-button'),
                tabContents: document.querySelectorAll('.tab-content'),
                // Elementos da c√¢mera
                cameraSection: document.getElementById('camera-section'),
                startCameraBtn: document.getElementById('start-camera'),
                takePhotoBtn: document.getElementById('take-photo'),
                closeCameraBtn: document.getElementById('close-camera'),
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                photoPreview: document.getElementById('photo-preview'),
                photoResult: document.getElementById('photo-result'),
                usePhotoBtn: document.getElementById('use-photo'),
                retakePhotoBtn: document.getElementById('retake-photo'),
                liveCoords: document.getElementById('live-coords'),
                coordsOverlay: document.getElementById('coords-overlay')
            };

            // Vari√°veis globais
            let points = [];
            let currentMarker = null;
            let gpsMarker = null;
            let gpsAccuracyCircle = null;
            let gpsWatchId = null;
            let map = null;
            let currentLat = -3.1190;
            let currentLng = -60.0217;
            let isGpsActive = false;
            
            // Vari√°veis da c√¢mera
            let stream = null;
            let currentPhotoData = null;
            let coordsUpdateInterval = null;

            // Munic√≠pios do Amazonas
            const municipios = [
                { id: 'manaus', nome: 'Manaus', lat: -3.1190, lng: -60.0217 },
                { id: 'alvaraes', nome: 'Alvar√£es', lat: -3.2142, lng: -64.8042 },
                { id: 'amatura', nome: 'Amatur√°', lat: -3.3656, lng: -68.1914 },
                { id: 'anama', nome: 'Anam√£', lat: -3.5797, lng: -61.3989 },
                { id: 'anori', nome: 'Anori', lat: -3.7461, lng: -61.6575 },
                { id: 'apui', nome: 'Apu√≠', lat: -7.1947, lng: -59.8931 },
                { id: 'atalaia-do-norte', nome: 'Atalaia do Norte', lat: -4.3722, lng: -70.1914 },
                { id: 'autazes', nome: 'Autazes', lat: -3.5858, lng: -59.1306 },
                { id: 'barcelos', nome: 'Barcelos', lat: -0.9758, lng: -62.9239 },
                { id: 'barreirinha', nome: 'Barreirinha', lat: -2.7989, lng: -57.0678 },
                { id: 'benjamin-constant', nome: 'Benjamin Constant', lat: -4.3758, lng: -70.0319 },
                { id: 'beruri', nome: 'Beruri', lat: -3.8989, lng: -61.3708 },
                { id: 'boa-vista-do-ramos', nome: 'Boa Vista do Ramos', lat: -2.9739, lng: -57.5878 },
                { id: 'boca-do-acre', nome: 'Boca do Acre', lat: -8.7522, lng: -67.3978 },
                { id: 'borba', nome: 'Borba', lat: -4.3914, lng: -59.5886 },
                { id: 'caapiranga', nome: 'Caapiranga', lat: -3.3289, lng: -61.2114 },
                { id: 'canutama', nome: 'Canutama', lat: -6.5339, lng: -64.3831 },
                { id: 'carauari', nome: 'Carauari', lat: -4.8825, lng: -66.8958 },
                { id: 'careiro', nome: 'Careiro', lat: -3.7681, lng: -60.3689 },
                { id: 'careiro-da-varzea', nome: 'Careiro da V√°rzea', lat: -3.1969, lng: -59.8258 },
                { id: 'coari', nome: 'Coari', lat: -4.0850, lng: -63.1414 },
                { id: 'codajas', nome: 'Codaj√°s', lat: -3.8367, lng: -62.0569 },
                { id: 'eirunepe', nome: 'Eirunep√©', lat: -6.6600, lng: -69.8736 },
                { id: 'envira', nome: 'Envira', lat: -7.4381, lng: -70.0281 },
                { id: 'fonte-boa', nome: 'Fonte Boa', lat: -2.5139, lng: -66.0919 },
                { id: 'guajara', nome: 'Guajar√°', lat: -7.5378, lng: -72.5814 },
                { id: 'humaita', nome: 'Humait√°', lat: -7.5114, lng: -63.0206 },
                { id: 'ipixuna', nome: 'Ipixuna', lat: -7.0489, lng: -71.6939 },
                { id: 'iranduba', nome: 'Iranduba', lat: -3.2850, lng: -60.1861 },
                { id: 'itacoatiara', nome: 'Itacoatiara', lat: -3.1431, lng: -58.4442 },
                { id: 'itamarati', nome: 'Itamarati', lat: -6.4389, lng: -68.2439 },
                { id: 'itapiranga', nome: 'Itapiranga', lat: -2.7461, lng: -58.0208 },
                { id: 'japura', nome: 'Japur√°', lat: -1.8822, lng: -66.9992 },
                { id: 'jurua', nome: 'Juru√°', lat: -3.4758, lng: -66.0639 },
                { id: 'juta√≠', nome: 'Juta√≠', lat: -2.7481, lng: -66.7678 },
                { id: 'l√°brea', nome: 'L√°brea', lat: -7.2589, lng: -64.7958 },
                { id: 'manacapuru', nome: 'Manacapuru', lat: -3.3008, lng: -60.6206 },
                { id: 'manaquiri', nome: 'Manaquiri', lat: -3.4139, lng: -60.4608 },
                { id: 'manicore', nome: 'Manicor√©', lat: -5.8092, lng: -61.3003 },
                { id: 'maraa', nome: 'Mara√£', lat: -1.8539, lng: -65.5731 },
                { id: 'maues', nome: 'Mau√©s', lat: -3.3839, lng: -57.7186 },
                { id: 'nhamunda', nome: 'Nhamund√°', lat: -2.1869, lng: -56.7139 },
                { id: 'nova-olinda-do-norte', nome: 'Nova Olinda do Norte', lat: -3.8889, lng: -59.0942 },
                { id: 'novo-air√£o', nome: 'Novo Air√£o', lat: -2.6208, lng: -60.9439 },
                { id: 'novo-aripuana', nome: 'Novo Aripuan√£', lat: -5.1258, lng: -60.3739 },
                { id: 'parintins', nome: 'Parintins', lat: -2.6276, lng: -56.7358 },
                { id: 'pauini', nome: 'Pauini', lat: -7.7139, lng: -66.9764 },
                { id: 'presidente-figueiredo', nome: 'Presidente Figueiredo', lat: -2.0508, lng: -60.0239 },
                { id: 'rio-preto-da-eva', nome: 'Rio Preto da Eva', lat: -2.6975, lng: -59.6958 },
                { id: 'santa-isabel-do-rio-negro', nome: 'Santa Isabel do Rio Negro', lat: -0.4139, lng: -65.0189 },
                { id: 'santo-antonio-do-ica', nome: 'Santo Ant√¥nio do I√ß√°', lat: -3.1022, lng: -67.9397 },
                { id: 'sao-gabriel-da-cachoeira', nome: 'S√£o Gabriel da Cachoeira', lat: -0.1306, lng: -67.0892 },
                { id: 'sao-paulo-de-olivenca', nome: 'S√£o Paulo de Oliven√ßa', lat: -3.4658, lng: -68.9508 },
                { id: 'sao-sebastiao-do-uatuma', nome: 'S√£o Sebasti√£o do Uatum√£', lat: -2.5708, lng: -57.8739 },
                { id: 'silves', nome: 'Silves', lat: -2.8389, lng: -58.2089 },
                { id: 'tabatinga', nome: 'Tabatinga', lat: -4.2517, lng: -69.9378 },
                { id: 'tapaua', nome: 'Tapau√°', lat: -5.6208, lng: -63.1839 },
                { id: 'tefe', nome: 'Tef√©', lat: -3.3547, lng: -64.7108 },
                { id: 'tonantins', nome: 'Tonantins', lat: -2.8739, lng: -67.8019 },
                { id: 'uarini', nome: 'Uarini', lat: -2.9908, lng: -65.1081 },
                { id: 'urucara', nome: 'Urucar√°', lat: -2.5369, lng: -57.7589 },
                { id: 'urucurituba', nome: 'Urucurituba', lat: -3.1289, lng: -58.1558 }
            ];

            // Inicializa√ß√£o
            function init() {
                initMap();
                setupEventListeners();
                loadPointsFromStorage();
                updateStats();
                
                // Mostrar se√ß√£o da c√¢mera apenas em mobile
                if (isMobileDevice()) {
                    elements.cameraSection.style.display = 'block';
                    updateLiveCoords();
                }
            }

            // Fun√ß√µes do Mapa
            function initMap() {
                map = L.map('map', {
                    center: [currentLat, currentLng],
                    zoom: 10,
                    minZoom: 6,
                    maxZoom: 18,
                    maxBounds: [[-12, -75], [2, -50]]
                });
                
                const baseLayers = {
                    "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '&copy; Esri', maxZoom: 18
                    }),
                    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors', maxZoom: 18
                    })
                };
                
                baseLayers["Sat√©lite"].addTo(map);
                L.control.layers(baseLayers).addTo(map);

                map.on('click', function(e) {
                    updateCoordinates(e.latlng.lat, e.latlng.lng);
                    if (currentMarker) map.removeLayer(currentMarker);
                    currentMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                        icon: L.divIcon({ className: 'custom-marker marker-pulse', iconSize: [18, 18] })
                    }).addTo(map);
                });

                updateCoordinates(currentLat, currentLng);
                populateMunicipiosDropdown();
            }

            function setupEventListeners() {
                elements.addPoint.addEventListener('click', addPoint);
                elements.addGpsPoint.addEventListener('click', addGpsPoint);
                elements.clearPoints.addEventListener('click', clearPoints);
                elements.exportKml.addEventListener('click', exportKml);
                elements.centerMap.addEventListener('click', centerMap);
                elements.zoomIn.addEventListener('click', () => map.zoomIn());
                elements.zoomOut.addEventListener('click', () => map.zoomOut());
                elements.locateMe.addEventListener('click', toggleGps);
                elements.municipioSelect.addEventListener('change', changeMunicipio);
                elements.searchLocation.addEventListener('keypress', searchLocation);
                elements.goToCoords.addEventListener('click', goToManualCoords);
                
                elements.tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        elements.tabButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        elements.tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                    });
                });

                // Event listeners da c√¢mera
                elements.startCameraBtn.addEventListener('click', startCamera);
                elements.takePhotoBtn.addEventListener('click', takePhoto);
                elements.usePhotoBtn.addEventListener('click', usePhoto);
                elements.retakePhotoBtn.addEventListener('click', retakePhoto);
                elements.closeCameraBtn.addEventListener('click', closeCamera);
            }

            function populateMunicipiosDropdown() {
                municipios.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.textContent = m.nome;
                    elements.municipioSelect.appendChild(option);
                });
                elements.municipioSelect.value = 'manaus';
            }

            function changeMunicipio() {
                const municipio = municipios.find(m => m.id === elements.municipioSelect.value);
                if (municipio) {
                    map.setView([municipio.lat, municipio.lng], 10);
                    updateCoordinates(municipio.lat, municipio.lng);
                }
            }

            function searchLocation(e) {
                if (e.key === 'Enter') {
                    const query = elements.searchLocation.value.trim().toLowerCase();
                    if (query) {
                        const municipio = municipios.find(m => m.nome.toLowerCase().includes(query));
                        if (municipio) {
                            map.setView([municipio.lat, municipio.lng], 12);
                            updateCoordinates(municipio.lat, municipio.lng);
                            elements.municipioSelect.value = municipio.id;
                            showNotification(`Localizado: ${municipio.nome}`, 'success');
                        } else {
                            showNotification('Munic√≠pio n√£o encontrado', 'warning');
                        }
                    }
                }
            }

            function goToManualCoords() {
                const lat = parseFloat(elements.manualLat.value.replace(',', '.'));
                const lng = parseFloat(elements.manualLng.value.replace(',', '.'));
                
                if (isNaN(lat) || isNaN(lng)) {
                    showNotification('Coordenadas inv√°lidas. Use formato decimal (ex: -3.1190, -60.0217)', 'warning');
                    return;
                }
                
                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    showNotification('Coordenadas fora do intervalo v√°lido', 'warning');
                    return;
                }
                
                map.setView([lat, lng], 15);
                updateCoordinates(lat, lng);
                
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.marker([lat, lng], {
                    icon: L.divIcon({ className: 'custom-marker marker-pulse', iconSize: [18, 18] })
                }).addTo(map);
                
                showNotification(`Navegando para: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
            }

            // Fun√ß√µes do GPS
            function toggleGps() {
                if (isGpsActive) stopGps();
                else startGps();
            }

            function startGps() {
                if (!navigator.geolocation) {
                    showNotification('Geolocaliza√ß√£o n√£o suportada.', 'warning');
                    return;
                }

                showNotification('Ativando GPS...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        updateCoordinates(lat, lng);
                        map.setView([lat, lng], 15);
                        
                        const gpsIcon = L.divIcon({
                            className: 'gps-marker',
                            html: `<div style="width:20px;height:20px;background:#2196f3;border:2px solid white;border-radius:50%;box-shadow:0 0 10px rgba(33,150,243,0.7);display:flex;align-items:center;justify-content:center;animation:pulse 2s infinite;"><div style="width:6px;height:6px;background:white;border-radius:50%;"></div></div>`,
                            iconSize: [20, 20], iconAnchor: [10, 10]
                        });
                        
                        if (gpsMarker) map.removeLayer(gpsMarker);
                        gpsMarker = L.marker([lat, lng], { icon: gpsIcon, zIndexOffset: 1000 }).addTo(map);
                        
                        if (gpsAccuracyCircle) map.removeLayer(gpsAccuracyCircle);
                        gpsAccuracyCircle = L.circle([lat, lng], {
                            color: '#2196f3', fillColor: '#2196f3', fillOpacity: 0.1,
                            radius: position.coords.accuracy
                        }).addTo(map);
                        
                        gpsMarker.bindPopup(`
                            <div style="min-width:180px;">
                                <h3 style="margin:0 0 5px 0;color:#0d47a1;font-size:0.9rem;">üìç Sua Localiza√ß√£o</h3>
                                <p style="margin:0;font-size:0.7rem;color:#666;">${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                            </div>
                        `);
                        
                        elements.gpsAccuracy.textContent = Math.round(position.coords.accuracy);
                        elements.gpsStatus.style.display = 'block';
                        
                        gpsWatchId = navigator.geolocation.watchPosition(
                            updateGpsPosition, handleGpsError,
                            { enableHighAccuracy: true, timeout: 5000, maximumAge: 1000 }
                        );
                        
                        isGpsActive = true;
                        elements.locateMe.classList.add('gps-active');
                        showNotification('GPS ativado!', 'success');
                    },
                    handleGpsError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            function updateGpsPosition(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                if (gpsMarker) {
                    gpsMarker.setLatLng([lat, lng]);
                    if (map.getZoom() > 14) map.panTo([lat, lng], { animate: true, duration: 1 });
                }
                
                if (gpsAccuracyCircle) {
                    gpsAccuracyCircle.setLatLng([lat, lng]);
                    gpsAccuracyCircle.setRadius(position.coords.accuracy);
                }
                
                updateCoordinates(lat, lng);
                elements.gpsAccuracy.textContent = Math.round(position.coords.accuracy);
            }

            function handleGpsError(error) {
                let message = 'Erro ao obter localiza√ß√£o: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED: message += 'Permiss√£o negada.'; break;
                    case error.POSITION_UNAVAILABLE: message += 'Localiza√ß√£o indispon√≠vel.'; break;
                    case error.TIMEOUT: message += 'Tempo esgotado.'; break;
                    default: message += 'Erro desconhecido.'; break;
                }
                showNotification(message, 'warning');
                stopGps();
            }

            function stopGps() {
                if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
                if (gpsMarker) map.removeLayer(gpsMarker);
                if (gpsAccuracyCircle) map.removeLayer(gpsAccuracyCircle);
                elements.gpsStatus.style.display = 'none';
                elements.locateMe.classList.remove('gps-active');
                isGpsActive = false;
                showNotification('GPS desativado.', 'info');
            }

            // Fun√ß√µes dos Pontos
            function addPoint() {
                const name = elements.pointName.value.trim() || `${getCategoryName(elements.pointCategory.value)} ${points.length + 1}`;
                const description = elements.pointDesc.value.trim();
                const category = elements.pointCategory.value;
                const municipio = municipios.find(m => m.id === elements.municipioSelect.value);

                const point = {
                    id: Date.now(), name, description, category,
                    lat: currentLat, lng: currentLng,
                    timestamp: new Date().toISOString(),
                    municipio: municipio ? municipio.nome : 'Desconhecido',
                    source: 'manual'
                };

                if (currentPhotoData) {
                    point.photo = currentPhotoData;
                    point.hasGeophoto = true;
                }

                points.push(point);
                renderPointsList();
                addPointToMap(point);
                savePointsToStorage();
                updateStats();

                elements.pointName.value = '';
                elements.pointDesc.value = '';
                showNotification(`"${name}" registrado!`, 'success');
            }

            function addGpsPoint() {
                if (!isGpsActive) {
                    showNotification('Ative o GPS primeiro!', 'warning');
                    return;
                }

                const name = elements.pointName.value.trim() || `${getCategoryName(elements.pointCategory.value)} GPS ${points.length + 1}`;
                const description = elements.pointDesc.value.trim() || 'Registrado via GPS em tempo real';
                const municipio = municipios.find(m => m.id === elements.municipioSelect.value);

                const point = {
                    id: Date.now(), name, description,
                    category: elements.pointCategory.value,
                    lat: currentLat, lng: currentLng,
                    timestamp: new Date().toISOString(),
                    municipio: municipio ? municipio.nome : 'Desconhecido',
                    source: 'gps', accuracy: elements.gpsAccuracy.textContent
                };

                if (currentPhotoData) {
                    point.photo = currentPhotoData;
                    point.hasGeophoto = true;
                }

                points.push(point);
                renderPointsList();
                addPointToMap(point);
                savePointsToStorage();
                updateStats();

                elements.pointName.value = '';
                elements.pointDesc.value = '';
                showNotification(`"${name}" registrado via GPS!`, 'success');
            }

            function addPointToMap(point) {
                const isGps = point.source === 'gps';
                const iconColor = isGps ? '#2196f3' : '#4caf50';
                
                const marker = L.marker([point.lat, point.lng], {
                    icon: L.divIcon({
                        className: 'point-marker',
                        html: `<div style="background:${iconColor};width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>`,
                        iconSize: [12, 12], iconAnchor: [6, 6]
                    })
                }).addTo(map);
                
                const date = new Date(point.timestamp);
                const dateStr = date.toLocaleDateString('pt-BR');
                const timeStr = date.toLocaleTimeString('pt-BR');
                
                // Popup com foto se dispon√≠vel
                const photoHtml = point.photo ? 
                    `<div class="photo-popup">
                        <img src="${point.photo}" alt="Foto do ponto" style="max-width:100%;border:2px solid #4caf50;border-radius:5px;">
                        ${point.hasGeophoto ? '<p style="text-align:center;color:#4caf50;font-weight:bold;">üìç Foto Georreferenciada</p>' : ''}
                        <p style="font-size:0.8rem;color:#666;text-align:center;">
                            Coordenadas: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}<br>
                            Data: ${dateStr} ${timeStr}
                        </p>
                     </div>` : '';
                
                marker.bindPopup(`
                    <div style="min-width:200px;">
                        <h3 style="margin:0 0 5px 0;color:${iconColor};font-size:0.9rem;">
                            ${point.name} 
                            ${point.hasGeophoto ? 'üìç' : ''}
                        </h3>
                        <p style="margin:0 0 5px 0;font-size:0.8rem;">${point.description}</p>
                        <p style="margin:0 0 3px 0;font-size:0.7rem;color:#666;">${getCategoryName(point.category)} - ${point.municipio}</p>
                        ${isGps ? `<p style="margin:0 0 3px 0;font-size:0.7rem;color:#666;">Precis√£o: ${point.accuracy}m</p>` : ''}
                        <p style="margin:0;font-size:0.7rem;color:#666;">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</p>
                        ${photoHtml}
                    </div>
                `);

                marker.on('mouseover', function() {
                    elements.infoName.textContent = point.name;
                    elements.infoCoords.textContent = `${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}`;
                    elements.infoDesc.textContent = point.description;
                    elements.markerInfo.style.display = 'block';
                });

                marker.on('mouseout', function() {
                    elements.markerInfo.style.display = 'none';
                });

                point.marker = marker;
            }

            function clearPoints() {
                if (points.length === 0) {
                    showNotification('N√£o h√° pontos para limpar.', 'warning');
                    return;
                }

                if (confirm('Limpar todos os pontos registrados?')) {
                    points.forEach(point => { if (point.marker) map.removeLayer(point.marker); });
                    points = [];
                    renderPointsList();
                    savePointsToStorage();
                    updateStats();
                    showNotification('Todos os pontos removidos.', 'info');
                }
            }

            function renderPointsList() {
                elements.pointsCount.textContent = points.length;
                
                if (points.length === 0) {
                    elements.pointsContainer.innerHTML = '<p style="text-align:center;padding:10px;color:#aaa;font-size:0.8rem;">Nenhum ponto registrado</p>';
                    return;
                }

                const sortedPoints = [...points].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                elements.pointsContainer.innerHTML = sortedPoints.map(point => {
                    const date = new Date(point.timestamp);
                    const dateStr = date.toLocaleDateString('pt-BR');
                    const timeStr = date.toLocaleTimeString('pt-BR');
                    const isGps = point.source === 'gps';
                    const hasPhoto = point.photo ? 'point-has-photo' : '';
                    const hasGeophoto = point.hasGeophoto ? 'point-has-geophoto' : '';
                    
                    return `
                    <div class="point-item ${hasPhoto} ${hasGeophoto}">
                        <div class="point-info">
                            <div class="point-name">${point.name}</div>
                            <div class="point-details">
                                ${getCategoryName(point.category)} ‚Ä¢ ${point.municipio}<br>
                                ${dateStr} ${timeStr} ${isGps ? '‚Ä¢ üìç GPS' : ''}<br>
                                ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}
                            </div>
                        </div>
                        <div class="point-actions">
                            <button class="view-point" data-id="${point.id}" title="Visualizar">üëÅÔ∏è</button>
                            ${point.photo ? `<button class="view-photo" data-id="${point.id}" title="Ver Foto">üì∏</button>` : ''}
                            <button class="delete-point" data-id="${point.id}" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                    `;
                }).join('');

                document.querySelectorAll('.view-point').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const point = points.find(p => p.id === parseInt(this.dataset.id));
                        if (point) {
                            map.setView([point.lat, point.lng], 15);
                            if (point.marker) point.marker.openPopup();
                        }
                    });
                });

                document.querySelectorAll('.view-photo').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const point = points.find(p => p.id === parseInt(this.dataset.id));
                        if (point && point.photo) {
                            const newWindow = window.open();
                            newWindow.document.write(`
                                <html>
                                    <head><title>Foto - ${point.name}</title></head>
                                    <body style="margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;">
                                        <img src="${point.photo}" style="max-width:100%;max-height:100%;" alt="Foto do ponto">
                                    </body>
                                </html>
                            `);
                        }
                    });
                });

                document.querySelectorAll('.delete-point').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const point = points.find(p => p.id === parseInt(this.dataset.id));
                        if (point && confirm(`Excluir "${point.name}"?`)) {
                            if (point.marker) map.removeLayer(point.marker);
                            points = points.filter(p => p.id !== point.id);
                            renderPointsList();
                            savePointsToStorage();
                            updateStats();
                            showNotification(`"${point.name}" exclu√≠do.`, 'info');
                        }
                    });
                });
            }

            function updateCoordinates(lat, lng) {
                currentLat = lat;
                currentLng = lng;
                elements.currentCoords.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                updateLiveCoords();
            }

            function getCategoryName(category) {
                const categories = {
                    'ponte-oae': 'Ponte - OAE', 'bueiro-oae': 'Bueiro - OAE', 
                    'galeria-oae': 'Galeria - OAE', 'viario-urbano': 'Vi√°rio - Urbano',
                    'jazida': 'Jazida', 'ramal': 'Ramal', 'rodovia': 'Rodovia',
                    'patologias-pista': 'Patologias na Pista', 'viaduto-oae': 'Viaduto - OAE'
                };
                return categories[category] || 'Desconhecida';
            }

            function updateStats() {
                elements.totalPoints.textContent = points.length;
                elements.categoriesCount.textContent = points.length > 0 ? new Set(points.map(p => p.category)).size : '0';
            }

            function centerMap() {
                const municipio = municipios.find(m => m.id === elements.municipioSelect.value);
                if (municipio) {
                    map.setView([municipio.lat, municipio.lng], 10);
                    updateCoordinates(municipio.lat, municipio.lng);
                }
            }

            function exportKml() {
                if (points.length === 0) {
                    showNotification('N√£o h√° pontos para exportar.', 'warning');
                    return;
                }

                try {
                    let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>GeoMarker - DMOB</name>
    <description>Pontos registrados no GeoMarker - DMOB</description>
    <Style id="yellowStyle">
        <IconStyle><color>ff00ffff</color><scale>1.2</scale><Icon><href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href></Icon></IconStyle>
    </Style>`;

                    points.forEach(point => {
                        const date = new Date(point.timestamp);
                        const metadata = `
<b>METADADOS:</b><br/>
<table border="1" style="border-collapse:collapse;width:100%;">
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Identifica√ß√£o:</b></td><td style="padding:5px;">${point.name}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Categoria:</b></td><td style="padding:5px;">${getCategoryName(point.category)}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Munic√≠pio:</b></td><td style="padding:5px;">${point.municipio}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Descri√ß√£o:</b></td><td style="padding:5px;">${point.description || 'N√£o informada'}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Fonte:</b></td><td style="padding:5px;">${point.source === 'gps' ? 'GPS' : 'Manual'}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Data:</b></td><td style="padding:5px;">${date.toLocaleDateString('pt-BR')}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Hora:</b></td><td style="padding:5px;">${date.toLocaleTimeString('pt-BR')}</td></tr>
  <tr><td style="padding:5px;background:#f0f0f0;"><b>Coordenadas:</b></td><td style="padding:5px;">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</td></tr>
  ${point.accuracy ? `<tr><td style="padding:5px;background:#f0f0f0;"><b>Precis√£o:</b></td><td style="padding:5px;">${point.accuracy}m</td></tr>` : ''}
  ${point.photo ? `<tr><td style="padding:5px;background:#f0f0f0;"><b>Foto:</b></td><td style="padding:5px;">Sim (georreferenciada)</td></tr>` : ''}
</table>
<br/><b>SISTEMA:</b> GeoMarker - DMOB`;

                        kmlContent += `
    <Placemark>
        <name>${escapeXml(point.name)}</name>
        <description><![CDATA[${metadata}]]></description>
        <styleUrl>#yellowStyle</styleUrl>
        <Point><coordinates>${point.lng},${point.lat},0</coordinates></Point>
    </Placemark>`;
                    });

                    kmlContent += `\n</Document>\n</kml>`;

                    const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `geomarker_${new Date().toISOString().split('T')[0]}.kml`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`KML com ${points.length} pontos exportado!`, 'success');
                } catch (error) {
                    showNotification(`Erro ao exportar: ${error.message}`, 'error');
                }
            }

            function escapeXml(unsafe) {
                return unsafe.replace(/[<>&'"]/g, c => {
                    switch(c) { case '<': return '&lt;'; case '>': return '&gt;'; case '&': return '&amp;'; case '\'': return '&apos;'; case '"': return '&quot;'; }
                });
            }

            function showNotification(message, type) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.cssText = `
                    position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:5px;color:white;font-weight:600;z-index:10000;max-width:300px;font-size:0.8rem;box-shadow:0 5px 15px rgba(0,0,0,0.3);transition:all 0.3s ease;
                    background:${type === 'success' ? 'linear-gradient(135deg,#4caf50,#8bc34a)' : type === 'warning' ? 'linear-gradient(135deg,#ff9800,#ff5722)' : 'linear-gradient(135deg,#2196f3,#3f51b5)'};
                `;
                
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100px)';
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 3000);
            }

            function savePointsToStorage() {
                localStorage.setItem('geomarkerPoints', JSON.stringify({ points, timestamp: new Date().toISOString() }));
            }

            function loadPointsFromStorage() {
                const savedData = localStorage.getItem('geomarkerPoints');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        if (data.points && Array.isArray(data.points)) {
                            points = data.points;
                            points.forEach(point => addPointToMap(point));
                            renderPointsList();
                        }
                    } catch (e) {
                        console.error('Erro ao carregar pontos:', e);
                    }
                }
            }

            // Fun√ß√µes da C√¢mera
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            function updateLiveCoords() {
                if (currentLat && currentLng) {
                    const lat = currentLat.toFixed(6);
                    const lng = currentLng.toFixed(6);
                    elements.liveCoords.textContent = `${lat}, ${lng}`;
                } else {
                    elements.liveCoords.textContent = '--,--';
                }
            }

            async function startCamera() {
                try {
                    showNotification('Acessando c√¢mera...', 'info');
                    
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }, 
                        audio: false 
                    });
                    
                    elements.video.srcObject = stream;
                    elements.cameraPreview.style.display = 'block';
                    elements.takePhotoBtn.style.display = 'inline-block';
                    elements.closeCameraBtn.style.display = 'inline-block';
                    elements.startCameraBtn.style.display = 'none';
                    
                    elements.coordsOverlay.style.display = 'block';
                    coordsUpdateInterval = setInterval(updateLiveCoords, 1000);
                    
                    showNotification('C√¢mera pronta! As coordenadas aparecer√£o na foto.', 'success');
                } catch (error) {
                    console.error('Erro ao acessar c√¢mera:', error);
                    showNotification('Erro ao acessar c√¢mera: ' + error.message, 'error');
                }
            }

            function takePhoto() {
                const context = elements.canvas.getContext('2d');
                elements.canvas.width = elements.video.videoWidth;
                elements.canvas.height = elements.video.videoHeight;
                
                context.drawImage(elements.video, 0, 0, elements.canvas.width, elements.canvas.height);
                addCoordinatesWatermark(context, elements.canvas.width, elements.canvas.height);
                
                currentPhotoData = elements.canvas.toDataURL('image/jpeg', 0.8);
                elements.photoPreview.src = currentPhotoData;
                elements.photoPreview.classList.add('photo-with-coords');
                
                elements.photoResult.style.display = 'block';
                elements.cameraPreview.style.display = 'none';
                elements.takePhotoBtn.style.display = 'none';
                elements.coordsOverlay.style.display = 'none';
                
                showNotification('Foto com coordenadas capturada!', 'success');
            }

            function addCoordinatesWatermark(context, width, height) {
                const coordsText = `üìç ${currentLat.toFixed(6)}, ${currentLng.toFixed(6)}`;
                const timestamp = new Date().toLocaleString('pt-BR');
                const municipio = municipios.find(m => m.id === elements.municipioSelect.value)?.nome || 'Desconhecido';
                
                context.font = 'bold 24px Arial';
                context.textAlign = 'right';
                context.textBaseline = 'top';
                
                const textMetrics = context.measureText(coordsText);
                const textWidth = textMetrics.width;
                const padding = 15;
                
                // Coordenadas (canto superior direito)
                context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                context.fillRect(width - textWidth - padding * 2, 10, textWidth + padding * 2, 35);
                context.fillStyle = '#4caf50';
                context.fillText(coordsText, width - padding, 15);
                
                // Data/hora (canto inferior esquerdo)
                context.font = 'bold 18px Arial';
                context.textAlign = 'left';
                const timeMetrics = context.measureText(timestamp);
                context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                context.fillRect(10, height - 55, timeMetrics.width + padding * 2, 45);
                context.fillStyle = 'white';
                context.fillText(timestamp, 15, height - 50);
                
                // Munic√≠pio (canto inferior direito)
                context.textAlign = 'right';
                const municipioMetrics = context.measureText(municipio);
                context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                context.fillRect(width - municipioMetrics.width - padding * 2, height - 55, municipioMetrics.width + padding * 2, 45);
                context.fillStyle = '#2196f3';
                context.fillText(municipio, width - padding, height - 50);
                
                // Borda de identifica√ß√£o
                context.strokeStyle = '#4caf50';
                context.lineWidth = 4;
                context.strokeRect(2, 2, width - 4, height - 4);
            }

            function usePhoto() {
                if (!currentPhotoData) {
                    showNotification('Nenhuma foto capturada!', 'warning');
                    return;
                }

                const now = new Date();
                const pointName = `Foto_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                
                elements.pointName.value = pointName;
                elements.pointDesc.value = `üì∏ Foto georreferenciada\nüìç Coordenadas: ${currentLat.toFixed(6)}, ${currentLng.toFixed(6)}\nüìÖ Data: ${now.toLocaleString('pt-BR')}\nüèôÔ∏è Munic√≠pio: ${municipios.find(m => m.id === elements.municipioSelect.value)?.nome || 'Desconhecido'}`;
                elements.pointCategory.value = 'patologias-pista';
                
                showNotification('Foto georreferenciada carregada! Preencha os dados e registre o ponto.', 'success');
                closeCamera();
            }

            function retakePhoto() {
                elements.photoResult.style.display = 'none';
                elements.cameraPreview.style.display = 'block';
                elements.takePhotoBtn.style.display = 'inline-block';
                elements.coordsOverlay.style.display = 'block';
                currentPhotoData = null;
                elements.photoPreview.classList.remove('photo-with-coords');
            }

            function closeCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                if (coordsUpdateInterval) {
                    clearInterval(coordsUpdateInterval);
                    coordsUpdateInterval = null;
                }
                
                elements.video.srcObject = null;
                elements.cameraPreview.style.display = 'none';
                elements.photoResult.style.display = 'none';
                elements.takePhotoBtn.style.display = 'none';
                elements.closeCameraBtn.style.display = 'none';
                elements.coordsOverlay.style.display = 'none';
                elements.startCameraBtn.style.display = 'inline-block';
                currentPhotoData = null;
                elements.photoPreview.classList.remove('photo-with-coords');
            }

            // Inicializar aplica√ß√£o
            init();
        });
    </script>
</body>
</html>
